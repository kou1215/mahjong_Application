<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Mahjong Simulator</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <style>
    #game-info {
      background: #2c5d3f;
      color: #fff;
      border-radius: 10px;
      padding: 12px 24px;
      margin: 18px 0 18px 0;
      display: flex;
      align-items: center;
      font-size: 1.15em;
      gap: 32px;
    }
    #dora-indicator-area {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .dora-tile {
      width: 48px;
      height: 70px;
      border-radius: 6px;
      border: 2px solid gold;
      box-shadow: 0 2px 8px rgba(0,0,0,0.18);
      background: #fff;
      object-fit: contain;
      margin-left: 6px;
    }
    #remaining-draws {
      font-weight: bold;
      font-size: 1.1em;
    }
  </style>
</head>
<body>

  <h1>Mahjong Simulator</h1>

  <div id="game-info">
    <div id="dora-indicator-area">
      ãƒ‰ãƒ©è¡¨ç¤ºç‰Œ:
      {% if hands_view and dora_indicator %}
        <img id="dora-indicator-img" class="tile dora-tile" src="/static/tiles/{{ dora_indicator }}.png" alt="{{ dora_indicator }}" onerror="handleImageError(this, '{{ dora_indicator }}')">
      {% else %}
        <span id="dora-indicator-img"></span>
      {% endif %}
    </div>
    <div id="remaining-draws" style="margin-left:24px;">æ®‹ã‚Šãƒ„ãƒ¢å›æ•°: <span id="remaining-draws-count">{{ remaining_draws if hands_view else '' }}</span></div>
  </div>

  <form action="/reset" method="get" style="display:inline; margin-right:16px;">
    <button type="submit">æ–°è¦å¯¾å±€ï¼ˆãƒªã‚»ãƒƒãƒˆï¼‰</button>
  </form>

  <div id="gameover-message" style="display:none; color:red; font-size:1.3em; margin:12px 0;">æµå±€ï¼ˆå±±ç‰ŒãŒãªããªã‚Šã¾ã—ãŸï¼‰</div>

  {% if hands_view %}
    <h2>Dealt Hands (images)</h2>
    <div class="hands-grid" id="hands-grid">
    {% for hv in hands_view %}
      <div id="player-{{ hv.player }}">
        <div><strong>Player {{ hv.player }}</strong> (shanten: <span class="shanten" id="shanten-{{ hv.player }}">{{ hv.shanten }}</span>)</div>
        <div class="tiles-row" id="tiles-row-{{ hv.player }}">
          {% for t in hv.tiles %}
            <img class="tile{% if hv.player == 0 %} clickable{% endif %}" data-player="{{ hv.player }}" data-index="{{ loop.index0 }}" src="{{ url_for('static', filename='tiles/' + t + '.png') }}" alt="{{ t }}">
          {% endfor %}
        </div>
        <div style="margin-top:6px; font-size:0.9em; color:#444" id="compact-{{ hv.player }}">{{ hv.compact }}</div>        {% if hv.player == 0 %}
          <button type="button" onclick="checkAgari()" style="margin-top:8px; padding:8px 16px; background:#4CAF50; color:white; border:none; border-radius:4px; cursor:pointer; font-weight:bold;">
            ğŸ¯ ã‚¢ã‚¬ã‚Šåˆ¤å®š
          </button>
        {% endif %}        <div class="discards" id="discards-{{ hv.player }}"></div>
      </div>
    {% endfor %}
    </div>
    <script>
    // ç”»åƒã‚¨ãƒ©ãƒ¼æ™‚ã«.pngâ†’.svgã¸åˆ‡ã‚Šæ›¿ãˆã‚‹å…±é€šé–¢æ•°
    function handleImageError(element, tileName) {
      if (element.src.endsWith('.png')) {
        element.onerror = null;
        element.src = '/static/tiles/' + tileName + '.svg';
      }
    }
    // æ¨ã¦ç‰Œå±¥æ­´
    const discards = [[], [], [], []];
    
    // æœ€å¾Œã«å¼•ã„ãŸç‰Œã‚’è¨˜éŒ²
    let lastDrawnTile = null;

    // Player 0 ã®æ‰‹ç‰Œã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
    function setTileClickHandlers() {
      document.querySelectorAll('#tiles-row-0 .tile.clickable').forEach(img => {
        img.onclick = function() {
          const idx = parseInt(this.getAttribute('data-index'));
          discardTile(idx);
        };
      });
    }

    // ç‰Œã‚¯ãƒªãƒƒã‚¯ç„¡åŠ¹åŒ–
    function disableTileClickHandlers() {
      document.querySelectorAll('#tiles-row-0 .tile.clickable').forEach(img => {
        img.onclick = null;
        img.classList.remove('clickable');
      });
    }

    async function discardTile(idx) {
      const formData = new FormData();
      formData.append('discard_index', idx);
      const res = await fetch('/discard', { method: 'POST', body: formData });
      if (!res.ok) {
        alert('ã‚¨ãƒ©ãƒ¼: ' + (await res.text()));
        return;
      }
      const data = await res.json();
      // æœ€æ–°ã®ã‚·ãƒ£ãƒ³ãƒ†ãƒ³æ•°ãƒªã‚¹ãƒˆã‚’windowã«ä¿å­˜
      window.shantenValues = data.shanten_list;
      lastDrawnTile = data.player0_draw; // æœ€å¾Œã«å¼•ã„ãŸç‰Œã‚’è¨˜éŒ²
      updateHands(data.hands, data.shanten_list);
      updateDiscards(data, data.auto_log);

      // ãƒ‰ãƒ©è¡¨ç¤ºç‰Œã®æ›´æ–°
      const doraImgArea = document.getElementById('dora-indicator-area');
      if (doraImgArea) {
        let doraImg = document.getElementById('dora-indicator-img');
        if (doraImg) {
          if (data.dora_indicator) {
            doraImg.src = '/static/tiles/' + data.dora_indicator + '.png';
            doraImg.alt = data.dora_indicator;
            doraImg.onerror = function() { handleImageError(this, data.dora_indicator); };
          } else {
            doraImg.src = '';
            doraImg.alt = '';
          }
        } else if (data.dora_indicator) {
          // ç”»åƒãŒãªã‘ã‚Œã°æ–°è¦ä½œæˆ
          doraImg = document.createElement('img');
          doraImg.id = 'dora-indicator-img';
          doraImg.className = 'tile dora-tile';
          doraImg.src = '/static/tiles/' + data.dora_indicator + '.png';
          doraImg.alt = data.dora_indicator;
          doraImg.onerror = function() { handleImageError(this, data.dora_indicator); };
          doraImgArea.appendChild(doraImg);
        }
      }

      // æ®‹ã‚Šãƒ„ãƒ¢å›æ•°ã®æ›´æ–°
      if (typeof data.remaining_draws !== 'undefined') {
        const drawsElem = document.getElementById('remaining-draws-count');
        if (drawsElem) {
          drawsElem.textContent = data.remaining_draws;
        }
      }

      if (data.is_game_over) {
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
        document.getElementById('gameover-message').style.display = '';
        // ç‰Œã‚¯ãƒªãƒƒã‚¯ç„¡åŠ¹åŒ–
        disableTileClickHandlers();
      } else {
        setTileClickHandlers();
      }
    }

    async function checkAgari() {
      if (!lastDrawnTile) {
        alert('å¼•ã„ãŸç‰ŒãŒã‚ã‚Šã¾ã›ã‚“');
        return;
      }

      const res = await fetch('/check_agari', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          player_id: 0,
          win_tile: lastDrawnTile,
          is_tsumo: true
        })
      });

      if (!res.ok) {
        alert('ã‚¨ãƒ©ãƒ¼: ' + (await res.text()));
        return;
      }

      const data = await res.json();
      showAgariResult(data);
    }

    function showAgariResult(data) {
      if (!data.agari) {
        alert('ã‚¢ã‚¬ã£ã¦ã„ã¾ã›ã‚“');
        return;
      }

      const value = data.value;
      if (!value || !value.valid) {
        alert('ã‚¢ã‚¬ãƒªãŒæˆç«‹ã—ã¦ã„ã¾ã›ã‚“: ' + (value ? value.error : 'Unknown error'));
        return;
      }

      const message = `
â˜… ã‚¢ã‚¬ã‚ŠæˆåŠŸï¼

ç¿»æ•°: ${value.han}ç¿»
ç¬¦æ•°: ${value.fu}ç¬¦
ç‚¹æ•°: ${value.cost.main}ç‚¹ï¼ˆå…¨å“¡ã‹ã‚‰åˆè¨ˆ ${value.cost.total}ç‚¹ï¼‰
é™åº¦: ${value.limit}
å½¹: ${value.yaku.join(', ')}
      `.trim();

      alert(message);
    }

    function updateHands(hands, shantenList) {
      for (let p = 0; p < hands.length; ++p) {
        const row = document.getElementById('tiles-row-' + p);
        if (!row) continue;
        row.innerHTML = '';
        hands[p].forEach((t, i) => {
          const img = document.createElement('img');
          img.className = 'tile' + (p === 0 ? ' clickable' : '');
          img.setAttribute('data-player', p);
          img.setAttribute('data-index', i);
          img.src = '/static/tiles/' + t + '.png';
          img.alt = t;
          img.onerror = function() { handleImageError(this, t); };
          row.appendChild(img);
        });
        // ã‚·ãƒ£ãƒ³ãƒ†ãƒ³æ•°ã‚‚æ›´æ–°
        const shantenSpan = document.getElementById('shanten-' + p);
        if (shantenSpan) {
          if (shantenList && shantenList[p] !== undefined) {
            shantenSpan.innerText = shantenList[p];
          } else {
            shantenSpan.innerText = '?';
          }
        }
      }
    }

    function updateDiscards(data, auto_log) {
      // Player 0
      if (data.discarded_tile !== undefined) {
        discards[0].push(data.discarded_tile);
        renderDiscards(0);
      }
      // Player 1-3
      if (auto_log) {
        auto_log.forEach(log => {
          discards[log.player].push(log.discarded);
          renderDiscards(log.player);
        });
      }
    }

    function renderDiscards(player) {
      const div = document.getElementById('discards-' + player);
      if (!div) return;
      div.innerHTML = '';
      discards[player].forEach(t => {
        const img = document.createElement('img');
        img.className = 'tile discard-tile';
        img.src = '/static/tiles/' + t + '.png';
        img.alt = t;
        img.onerror = function() { handleImageError(this, t); };
        div.appendChild(img);
      });
    }

    // åˆæœŸåŒ–
    setTileClickHandlers();
    </script>
  {% endif %}
</body>
</html>
