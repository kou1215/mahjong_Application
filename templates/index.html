<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Mahjong Simulator</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <style>
    #game-info {
      background: #2c5d3f;
      color: #fff;
      border-radius: 10px;
      padding: 12px 24px;
      margin: 18px 0 18px 0;
      display: flex;
      align-items: center;
      font-size: 1.15em;
      gap: 32px;
    }
    #dora-indicator-area {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .dora-tile {
      width: 48px;
      height: 70px;
      border-radius: 6px;
      border: 2px solid gold;
      box-shadow: 0 2px 8px rgba(0,0,0,0.18);
      background: #fff;
      object-fit: contain;
      margin-left: 6px;
    }
    #remaining-draws {
      font-weight: bold;
      font-size: 1.1em;
    }
  </style>
</head>
<body>

  <h1>Mahjong Simulator</h1>

  <div id="game-info">
    <div id="dora-indicator-area">
      ãƒ‰ãƒ©è¡¨ç¤ºç‰Œ:
      {% if hands_view and dora_indicator %}
        <img id="dora-indicator-img" class="tile dora-tile" src="/static/tiles/{{ dora_indicator }}.png" alt="{{ dora_indicator }}" onerror="handleImageError(this, '{{ dora_indicator }}')">
      {% else %}
        <span id="dora-indicator-img"></span>
      {% endif %}
    </div>
    <div id="remaining-draws" style="margin-left:24px;">æ®‹ã‚Šãƒ„ãƒ¢å›æ•°: <span id="remaining-draws-count">{{ remaining_draws if hands_view else '' }}</span></div>
  </div>

  <form action="/reset" method="get" style="display:inline; margin-right:16px;">
    <button type="submit">æ–°è¦å¯¾å±€ï¼ˆãƒªã‚»ãƒƒãƒˆï¼‰</button>
  </form>

  <div id="gameover-message" style="display:none; color:red; font-size:1.3em; margin:12px 0;">æµå±€ï¼ˆå±±ç‰ŒãŒãªããªã‚Šã¾ã—ãŸï¼‰</div>

  {% if hands_view %}
    <h2>Dealt Hands (images)</h2>
    <div class="hands-grid" id="hands-grid">
    {% for hv in hands_view %}
      <div id="player-{{ hv.player }}">
        <div><strong>Player {{ hv.player }}</strong> (shanten: <span class="shanten" id="shanten-{{ hv.player }}">{{ hv.shanten }}</span>)</div>
        <div class="tiles-row" id="tiles-row-{{ hv.player }}">
          {% for t in hv.tiles %}
            <img class="tile{% if hv.player == 0 %} clickable{% endif %}" data-player="{{ hv.player }}" data-index="{{ loop.index0 }}" src="{{ url_for('static', filename='tiles/' + t + '.png') }}" alt="{{ t }}">
          {% endfor %}
        </div>
        <div style="margin-top:6px; font-size:0.9em; color:#444" id="compact-{{ hv.player }}">{{ hv.compact }}</div>        {% if hv.player == 0 %}
          <button type="button" id="agari-button" onclick="checkAgari()" style="margin-top:8px; padding:8px 16px; background:#4CAF50; color:white; border:none; border-radius:4px; cursor:pointer; font-weight:bold;">
            ğŸ¯ ã‚¢ã‚¬ã‚Šåˆ¤å®š
          </button>
        {% endif %}        <div class="discards" id="discards-{{ hv.player }}"></div>
      </div>
    {% endfor %}
    </div>
    <script>
    // ç”»åƒã‚¨ãƒ©ãƒ¼æ™‚ã«.pngâ†’.svgã¸åˆ‡ã‚Šæ›¿ãˆã‚‹å…±é€šé–¢æ•°
    function handleImageError(element, tileName) {
      if (element.src.endsWith('.png')) {
        element.onerror = null;
        element.src = '/static/tiles/' + tileName + '.svg';
      }
    }
    // åˆæœŸã‚·ãƒ£ãƒ³ãƒ†ãƒ³å€¤ã‚’windowã«ä¿å­˜
    const handsData = {{ hands_view | tojson | safe | replace("'", '"') }};
    window.shantenValues = handsData.map(hv => {
      // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‹ã‚‰å–å¾—ã—ãŸã‚·ãƒ£ãƒ³ãƒ†ãƒ³å€¤ã‚’æŠ½å‡º
      return hv.shanten;
    });
    console.log('Initial hands data:', handsData);
    console.log('Initial shanten values:', window.shantenValues);

    // æ¨ã¦ç‰Œå±¥æ­´
    const discards = [[], [], [], []];
    // æœ€å¾Œã«å¼•ã„ãŸç‰Œã‚’è¨˜éŒ²
    let lastDrawnTile = null;
    window.player0_draw = null;

    // Player 0 ã®æ‰‹ç‰Œã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
    function setTileClickHandlers() {
      document.querySelectorAll('#tiles-row-0 .tile.clickable').forEach(img => {
        img.onclick = function() {
          const idx = parseInt(this.getAttribute('data-index'));
          discardTile(idx);
        };
      });
    }

    // ç‰Œã‚¯ãƒªãƒƒã‚¯ç„¡åŠ¹åŒ–
    function disableTileClickHandlers() {
      document.querySelectorAll('#tiles-row-0 .tile.clickable').forEach(img => {
        img.onclick = null;
        img.classList.remove('clickable');
      });
    }

    // ã‚¢ã‚¬ã‚Šå½¢åˆ¤å®šã§ãƒœã‚¿ãƒ³è‰²ã‚’æ›´æ–°
    function updateAgariButton() {
      const button = document.getElementById('agari-button');
      if (!button) return;
      
      // Player 0 ã®ã‚·ãƒ£ãƒ³ãƒ†ãƒ³æ•°ã‚’å–å¾—
      const shanten = window.shantenValues ? window.shantenValues[0] : null;
      
      if (shanten === -1) {
        // ã‚¢ã‚¬ã‚Šå½¢ï¼šãƒœã‚¿ãƒ³ã‚’ç›®ç«‹ã¤è‰²ï¼ˆã‚ªãƒ¬ãƒ³ã‚¸ç³»ï¼‰ã«å¤‰æ›´
        button.style.background = '#FF6B35';
        button.title = 'ã‚¢ã‚¬ã‚Šå½¢ã§ã™ï¼';
      } else if (shanten === 0) {
        // ãƒ†ãƒ³ãƒ‘ã‚¤ï¼šãƒœã‚¿ãƒ³ã‚’æ³¨æ„è‰²ã«
        button.style.background = '#FFB703';
        button.title = 'ãƒ†ãƒ³ãƒ‘ã‚¤ã—ã¦ã„ã¾ã™';
      } else {
        // é€šå¸¸çŠ¶æ…‹ï¼šç·‘
        button.style.background = '#4CAF50';
        button.title = '';
      }
    }

    async function discardTile(idx) {
      try {
        const formData = new FormData();
        formData.append('discard_index', idx);
        console.log('Sending discard request for index:', idx);
        
        const res = await fetch('/discard', { method: 'POST', body: formData });
        if (!res.ok) {
          const error = await res.text();
          console.error('Server error:', error);
          alert('ã‚¨ãƒ©ãƒ¼: ' + error);
          return;
        }
        const data = await res.json();
        console.log('Server response:', data);
        
        window.player0_draw = data.player0_draw;
        console.log('Updated player0_draw:', window.player0_draw);
        
        // æœ€æ–°ã®ã‚·ãƒ£ãƒ³ãƒ†ãƒ³æ•°ãƒªã‚¹ãƒˆã‚’windowã«ä¿å­˜
        window.shantenValues = data.shanten_list;
        lastDrawnTile = data.player0_draw;
        
        console.log('Calling updateHands...');
        updateHands(data.hands, data.shanten_list);
        console.log('updateHands completed');
        
        updateDiscards(data, data.auto_log);
        
        // ã‚¢ã‚¬ãƒªãƒœã‚¿ãƒ³ã®è‰²ã‚’æ›´æ–°
        updateAgariButton();

        // ãƒ‰ãƒ©è¡¨ç¤ºç‰Œã®æ›´æ–°
        const doraImgArea = document.getElementById('dora-indicator-area');
        if (doraImgArea) {
          let doraImg = document.getElementById('dora-indicator-img');
          if (doraImg) {
            if (data.dora_indicator) {
              doraImg.src = '/static/tiles/' + data.dora_indicator + '.png';
              doraImg.alt = data.dora_indicator;
              doraImg.onerror = function() { handleImageError(this, data.dora_indicator); };
            } else {
              doraImg.src = '';
              doraImg.alt = '';
            }
          } else if (data.dora_indicator) {
            doraImg = document.createElement('img');
            doraImg.id = 'dora-indicator-img';
            doraImg.className = 'tile dora-tile';
            doraImg.src = '/static/tiles/' + data.dora_indicator + '.png';
            doraImg.alt = data.dora_indicator;
            doraImg.onerror = function() { handleImageError(this, data.dora_indicator); };
            doraImgArea.appendChild(doraImg);
          }
        }

        // æ®‹ã‚Šãƒ„ãƒ¢å›æ•°ã®æ›´æ–°
        if (typeof data.remaining_draws !== 'undefined') {
          const drawsElem = document.getElementById('remaining-draws-count');
          if (drawsElem) {
            drawsElem.textContent = data.remaining_draws;
          }
        }

        if (data.is_game_over) {
          console.log('Game over');
          document.getElementById('gameover-message').style.display = '';
          disableTileClickHandlers();
        } else {
          console.log('Setting tile click handlers');
          setTileClickHandlers();
          console.log('Tile click handlers set');
        }
      } catch (error) {
        console.error('Exception in discardTile:', error);
        alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
      }
    }

    async function checkAgari() {
      if (!lastDrawnTile) {
        alert('å¼•ã„ãŸç‰ŒãŒã‚ã‚Šã¾ã›ã‚“');
        return;
      }

      const res = await fetch('/check_agari', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          player_id: 0,
          win_tile: lastDrawnTile,
          is_tsumo: true
        })
      });

      if (!res.ok) {
        alert('ã‚¨ãƒ©ãƒ¼: ' + (await res.text()));
        return;
      }

      const data = await res.json();
      showAgariResult(data);
    }

    function showAgariResult(data) {
      if (!data.agari) {
        alert('ã‚¢ã‚¬ã£ã¦ã„ã¾ã›ã‚“');
        return;
      }

      const value = data.value;
      if (!value || !value.valid) {
        alert('ã‚¢ã‚¬ãƒªãŒæˆç«‹ã—ã¦ã„ã¾ã›ã‚“: ' + (value ? value.error : 'Unknown error'));
        return;
      }

      const message = `
â˜… ã‚¢ã‚¬ã‚ŠæˆåŠŸï¼

ç¿»æ•°: ${value.han}ç¿»
ç¬¦æ•°: ${value.fu}ç¬¦
ç‚¹æ•°: ${value.cost.main}ç‚¹ï¼ˆå…¨å“¡ã‹ã‚‰åˆè¨ˆ ${value.cost.total}ç‚¹ï¼‰
é™åº¦: ${value.limit}
å½¹: ${value.yaku.join(', ')}
      `.trim();

      alert(message);
    }

    function updateHands(hands, shantenList) {
      console.log('updateHands called with:', hands.length, 'players');
      for (let p = 0; p < hands.length; ++p) {
        const row = document.getElementById('tiles-row-' + p);
        if (!row) {
          console.warn('tiles-row-' + p + ' not found');
          continue;
        }
        row.innerHTML = '';
        console.log('Player', p, ': hand length =', hands[p].length);
        
        if (p === 0) {
          // Player 0: ãƒ„ãƒ¢ç‰Œã‚’è¦–è¦šçš„ã«åˆ†é›¢ï¼ˆ2å·¡ç›®ä»¥é™ã®ã¿ï¼‰
          const hand = hands[0];
          const drawTile = window.player0_draw;
          console.log('Player 0: drawTile =', drawTile, ', hand =', hand);
          
          if (hand.length === 14 && drawTile) {
            console.log('Display mode: 13+1 (separated tsumo)');
            // ãƒ„ãƒ¢ç‰Œä»¥å¤–ã®13æšã‚’æ¢ã™
            let drawIdx = hand.lastIndexOf(drawTile);
            if (drawIdx === -1) {
              // è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯æœ€å¾Œã®ç‰Œã¨ä»®å®š
              drawIdx = 13;
              console.warn('drawTile not found in hand, using index 13');
            }
            console.log('drawIdx =', drawIdx);
            
            // 13æšã‚’æç”»ï¼ˆãƒ„ãƒ¢ç‰Œä»¥å¤–ï¼‰
            for (let i = 0; i < hand.length; i++) {
              if (i === drawIdx) continue; // ãƒ„ãƒ¢ç‰Œã¯å¾Œã§
              
              const img = document.createElement('img');
              img.className = 'tile clickable';
              img.setAttribute('data-player', 0);
              img.setAttribute('data-index', i);
              img.src = '/static/tiles/' + hand[i] + '.png';
              img.alt = hand[i];
              img.onerror = function() { handleImageError(this, hand[i]); };
              row.appendChild(img);
            }
            
            // ãƒ„ãƒ¢ç‰Œã‚’å³ç«¯ã«æç”»
            const tsumoImg = document.createElement('img');
            tsumoImg.className = 'tile clickable tsumo-tile';
            tsumoImg.setAttribute('data-player', 0);
            tsumoImg.setAttribute('data-index', drawIdx);
            tsumoImg.src = '/static/tiles/' + drawTile + '.png';
            tsumoImg.alt = drawTile;
            tsumoImg.onerror = function() { handleImageError(this, drawTile); };
            row.appendChild(tsumoImg);
            console.log('Player 0: rendered 13+1 layout');
          } else {
            console.log('Display mode: 14 (normal)');
            // åˆæ‰‹ã¾ãŸã¯ç„¡åŠ¹ãªçŠ¶æ…‹ï¼šé€šå¸¸è¡¨ç¤º
            hand.forEach((t, i) => {
              const img = document.createElement('img');
              img.className = 'tile clickable';
              img.setAttribute('data-player', 0);
              img.setAttribute('data-index', i);
              img.src = '/static/tiles/' + t + '.png';
              img.alt = t;
              img.onerror = function() { handleImageError(this, t); };
              row.appendChild(img);
            });
            console.log('Player 0: rendered 14-tile layout');
          }
        } else {
          // ä»–ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯å¾“æ¥é€šã‚Š
          hands[p].forEach((t, i) => {
            const img = document.createElement('img');
            img.className = 'tile';
            img.setAttribute('data-player', p);
            img.setAttribute('data-index', i);
            img.src = '/static/tiles/' + t + '.png';
            img.alt = t;
            img.onerror = function() { handleImageError(this, t); };
            row.appendChild(img);
          });
        }
        // ã‚·ãƒ£ãƒ³ãƒ†ãƒ³æ•°ã‚‚æ›´æ–°
        const shantenSpan = document.getElementById('shanten-' + p);
        if (shantenSpan && shantenList && shantenList[p] !== undefined) {
          const shantenVal = shantenList[p];
          // ã‚·ãƒ£ãƒ³ãƒ†ãƒ³æ•°ãŒ-1ã®å ´åˆã¯ã€Œã‚¢ã‚¬ã‚Šã€ã¨è¡¨ç¤º
          if (shantenVal === -1) {
            shantenSpan.innerText = 'ã‚¢ã‚¬ã‚Šå½¢';
            shantenSpan.style.color = '#FF6B35';
            shantenSpan.style.fontWeight = 'bold';
          } else if (shantenVal === 0) {
            shantenSpan.innerText = 'ãƒ†ãƒ³ãƒ‘ã‚¤';
            shantenSpan.style.color = '#FFB703';
            shantenSpan.style.fontWeight = 'bold';
          } else if (shantenVal >= 8) {
            // ä¸æ­£ãªæ‰‹ç‰Œãªã©
            shantenSpan.innerText = shantenVal;
            shantenSpan.style.color = '#999'; // ã‚°ãƒ¬ãƒ¼è¡¨ç¤º
            shantenSpan.title = 'ç„¡åŠ¹ãªæ‰‹ç‰Œ';
            shantenSpan.style.fontWeight = '';
          } else {
            shantenSpan.innerText = shantenVal;
            shantenSpan.style.color = '';
            shantenSpan.style.fontWeight = '';
          }
        }
      }
    }

    function updateDiscards(data, auto_log) {
      // Player 0
      if (data.discarded_tile !== undefined) {
        discards[0].push(data.discarded_tile);
        renderDiscards(0);
      }
      // Player 1-3
      if (auto_log) {
        auto_log.forEach(log => {
          discards[log.player].push(log.discarded);
          renderDiscards(log.player);
        });
      }
    }

    function renderDiscards(player) {
      const div = document.getElementById('discards-' + player);
      if (!div) return;
      div.innerHTML = '';
      discards[player].forEach(t => {
        const img = document.createElement('img');
        img.className = 'tile discard-tile';
        img.src = '/static/tiles/' + t + '.png';
        img.alt = t;
        img.onerror = function() { handleImageError(this, t); };
        div.appendChild(img);
      });
    }

    // åˆæœŸåŒ–
    setTileClickHandlers();
    updateAgariButton();
    </script>
  {% endif %}
</body>
</html>
